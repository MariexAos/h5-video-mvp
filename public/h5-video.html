<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <title>Video.js Custom Player</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 10px;
        background: #f5f5f5;
        min-height: 100vh;
        box-sizing: border-box;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .header h1 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
      }

      .header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 14px;
      }

      .content {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 20px;
        padding: 15px;
      }

      .video-section {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* è§†é¢‘æ’­æ”¾å™¨å®¹å™¨ */
      .video-js {
        width: 100% !important;
        height: auto !important;
        max-width: 100%;
      }

      /* ç§»åŠ¨ç«¯è§†é¢‘ä¼˜åŒ– */
      @media (max-width: 480px) {
        .video-js {
          width: 100% !important;
          height: auto !important;
          max-height: 250px;
        }
      }

      .events-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        border-left: 4px solid #667eea;
      }

      .events-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin: 0 0 15px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .events-log {
        background: #2d3748;
        color: #e2e8f0;
        border-radius: 6px;
        padding: 15px;
        height: 400px;
        overflow-y: auto;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 12px;
        line-height: 1.5;
      }

      .event-entry {
        margin-bottom: 8px;
        padding: 4px 8px;
        border-radius: 4px;
        border-left: 3px solid transparent;
      }

      .event-start {
        background: rgba(72, 187, 120, 0.1);
        border-left-color: #48bb78;
      }

      .event-timeupdate {
        background: rgba(66, 153, 225, 0.1);
        border-left-color: #4299e1;
      }

      .event-ended {
        background: rgba(245, 101, 101, 0.1);
        border-left-color: #f56565;
      }

      .event-seek {
        background: rgba(237, 137, 54, 0.1);
        border-left-color: #ed8936;
      }

      .event-timestamp {
        color: #a0aec0;
        font-size: 11px;
      }

      .controls-info {
        margin-top: 20px;
        padding: 15px;
        background: #e6fffa;
        border-radius: 6px;
        border-left: 4px solid #38b2ac;
        font-size: 14px;
        line-height: 1.5;
      }

      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
      }

      .status-active {
        background: #48bb78;
      }

      .status-disabled {
        background: #f56565;
      }

      @media (max-width: 900px) {
        body {
          padding: 5px;
        }

        .container {
          border-radius: 5px;
        }

        .header {
          padding: 15px;
        }

        .header h1 {
          font-size: 20px;
        }

        .header p {
          font-size: 13px;
        }

        .content {
          grid-template-columns: 1fr;
          gap: 15px;
          padding: 10px;
        }

        .events-section {
          order: -1;
        }

        .events-log {
          height: 200px;
        }

        .controls-info {
          margin-top: 15px;
          padding: 12px;
          font-size: 13px;
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 2px;
        }

        .container {
          border-radius: 3px;
          margin: 2px;
        }

        .header {
          padding: 10px;
        }

        .header h1 {
          font-size: 18px;
        }

        .header p {
          font-size: 12px;
        }

        .content {
          padding: 8px;
          gap: 10px;
        }

        .events-log {
          height: 150px;
          font-size: 11px;
        }

        .controls-info {
          padding: 10px;
          font-size: 12px;
        }

        .controls-info h3 {
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ“º Video.js MVP æ¼”ç¤º</h1>
        <p>é€šè¿‡ Video.js API æ§åˆ¶æ’­æ”¾å™¨åŠŸèƒ½ - ç¦ç”¨æ‹–æ‹½ï¼Œå¯ç”¨å€é€Ÿæ’­æ”¾</p>
      </div>

      <div class="content">
        <div class="video-section">
          <video
            id="my-video"
            class="video-js vjs-big-play-centered"
            controls
            preload="auto"
            data-setup="{}"
            style="width: 100%; height: auto"
          >
            <source
              src="https://vjs.zencdn.net/v/oceans.mp4"
              type="video/mp4"
            />
            <p class="vjs-no-js">
              To view this video please enable JavaScript, and consider
              upgrading to a web browser that
              <a href="https://videojs.com/html5-video-support/" target="_blank"
                >supports HTML5 video</a
              >
            </p>
          </video>

          <div class="controls-info">
            <h3 style="margin: 0 0 10px 0">ğŸ›ï¸ æ§åˆ¶çŠ¶æ€</h3>
            <div>
              <span class="status-indicator status-active"></span
              ><strong>æ’­æ”¾/æš‚åœ:</strong> å¯ç”¨
            </div>
            <div>
              <span class="status-indicator status-active"></span
              ><strong>éŸ³é‡æ§åˆ¶:</strong> å¯ç”¨
            </div>
            <div>
              <span class="status-indicator status-disabled"></span
              ><strong>å€é€Ÿæ’­æ”¾:</strong> ç¦ç”¨ (é€šè¿‡API)
            </div>
            <div>
              <span class="status-indicator status-disabled"></span
              ><strong>è¿›åº¦æ¡æ‹–æ‹½:</strong> ç¦ç”¨ (é€šè¿‡API)
            </div>
            <div>
              <span
                id="fullscreen-status"
                class="status-indicator status-disabled"
              ></span
              ><strong>å…¨å±æ¨¡å¼:</strong>
              <span id="fullscreen-text">iOSç¦ç”¨ (é€šè¿‡API)</span>
            </div>

            <!-- ğŸ”¥ NEW: æ¼”ç¤ºåˆ‡æ¢æŒ‰é’® -->
            <div
              style="
                margin-top: 15px;
                padding: 10px;
                background: #f0f8ff;
                border-radius: 5px;
                border-left: 4px solid #4299e1;
              "
            >
              <strong>ğŸ® æ¼”ç¤ºæ§åˆ¶:</strong>
              <button
                id="toggleFullscreenDemo"
                style="
                  margin-left: 10px;
                  padding: 6px 12px;
                  background: #4299e1;
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 12px;
                "
              >
                å¯ç”¨å…¨å± (æµ‹è¯•)
              </button>
              <div style="margin-top: 5px; font-size: 11px; color: #666">
                <div>ç‚¹å‡»æŒ‰é’®åˆ‡æ¢å…¨å±åŠŸèƒ½ï¼Œè§‚å¯Ÿæ•ˆæœï¼š</div>
                <div>â€¢ <strong>ç¦ç”¨æ—¶</strong>ï¼šæ— å…¨å±æŒ‰é’®ï¼Œå®Œå…¨é˜»æ­¢å…¨å±</div>
                <div>
                  â€¢ <strong>å¯ç”¨æ—¶</strong>ï¼šæ˜¾ç¤ºå…¨å±æŒ‰é’®ï¼ŒiOSå¯èƒ½æ¿€æ´»åŸç”Ÿæ’­æ”¾å™¨
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="events-section">
          <h3 class="events-title">
            ğŸ“Š äº‹ä»¶ç›‘æ§
            <button
              id="clearLog"
              style="
                margin-left: auto;
                padding: 4px 8px;
                border: none;
                background: #667eea;
                color: white;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
              "
            >
              æ¸…ç©ºæ—¥å¿—
            </button>
          </h3>
          <div id="events-log" class="events-log">
            <div class="event-entry">
              <span class="event-timestamp">[ç­‰å¾…äº‹ä»¶...]</span> ğŸ¬
              æ’­æ”¾å™¨åˆå§‹åŒ–ä¸­...
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script>
      // === äº‹ä»¶æ—¥å¿—ç³»ç»Ÿ ===
      const eventsLog = document.getElementById("events-log");
      const clearLogBtn = document.getElementById("clearLog");

      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, "0")}`;
      }

      function getCurrentTimestamp() {
        return new Date().toLocaleTimeString();
      }

      function addEventToLog(eventType, message, data = {}) {
        const eventEntry = document.createElement("div");
        eventEntry.className = `event-entry event-${eventType}`;

        const timestamp = getCurrentTimestamp();
        const icon =
          {
            start: "â–¶ï¸",
            timeupdate: "â±ï¸",
            ended: "â¹ï¸",
            seek: "â­ï¸",
            pause: "â¸ï¸",
            play: "â–¶ï¸",
            volumechange: "ğŸ”Š",
            fullscreenchange: "ğŸ“º",
            ratechange: "âš¡",
            loadstart: "ğŸ“¥",
            canplay: "âœ…",
            error: "âŒ",
            api: "ğŸ”§",
          }[eventType] || "ğŸ“¡";

        let logMessage = `<span class="event-timestamp">[${timestamp}]</span> ${icon} ${message}`;

        if (Object.keys(data).length > 0) {
          logMessage += `\n    ${JSON.stringify(data, null, 2)}`;
        }

        eventEntry.innerHTML = logMessage;
        eventsLog.appendChild(eventEntry);

        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        eventsLog.scrollTop = eventsLog.scrollHeight;

        // é™åˆ¶æ—¥å¿—æ¡æ•°
        const entries = eventsLog.querySelectorAll(".event-entry");
        if (entries.length > 100) {
          entries[0].remove();
        }
      }

      // æ¸…ç©ºæ—¥å¿—åŠŸèƒ½
      clearLogBtn.addEventListener("click", () => {
        eventsLog.innerHTML =
          '<div class="event-entry"><span class="event-timestamp">[' +
          getCurrentTimestamp() +
          "]</span> ğŸ§¹ æ—¥å¿—å·²æ¸…ç©º</div>";
      });

      // === Video.js æ’­æ”¾å™¨åˆå§‹åŒ– ===
      addEventToLog("api", "Video.js æ’­æ”¾å™¨åˆå§‹åŒ–å¼€å§‹...");

      // === ç§»åŠ¨ç«¯æ£€æµ‹åŠŸèƒ½ ===
      function detectDevice() {
        const userAgent = navigator.userAgent.toLowerCase();
        return {
          isMobile:
            /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(
              userAgent
            ),
          isIOS: /ipad|iphone|ipod/.test(userAgent),
          isAndroid: /android/.test(userAgent),
          isIPad: /ipad/.test(userAgent),
          isIPhone: /iphone/.test(userAgent),
          isSafari: /safari/.test(userAgent) && !/chrome/.test(userAgent),
          isChrome: /chrome/.test(userAgent),
          isFirefox: /firefox/.test(userAgent),
          supportsTouch:
            "ontouchstart" in window || navigator.maxTouchPoints > 0,
          supportsFullscreen: !!(
            document.fullscreenEnabled ||
            document.webkitFullscreenEnabled ||
            document.mozFullScreenEnabled ||
            document.msFullscreenEnabled
          ),
        };
      }

      const device = detectDevice();
      addEventToLog("api", `è®¾å¤‡æ£€æµ‹å®Œæˆ`, device);

      // === Video.js ç§»åŠ¨ç«¯å…¼å®¹æ€§é…ç½® ===
      const playerConfig = {
        // === åŸºç¡€é…ç½® ===
        playbackRates: false, // ç¦ç”¨å€æ•°æ’­æ”¾
        responsive: true, // å¯ç”¨å“åº”å¼
        fluid: true, // å¯ç”¨æµä½“å¸ƒå±€
        aspectRatio: "16:9", // è®¾ç½®å®½é«˜æ¯”

        // === ç§»åŠ¨ç«¯ç‰¹æ®Šé…ç½® ===
        mobileUi: device.isMobile, // ç§»åŠ¨ç«¯UIï¼ˆè‡ªé€‚åº”ï¼‰

        // === æŠ€æœ¯æ ˆé…ç½® ===
        techOrder: ["html5"], // ä¼˜å…ˆä½¿ç”¨HTML5 (ç§»åŠ¨ç«¯å…¼å®¹æ€§æœ€å¥½)

        // === HTML5æŠ€æœ¯é…ç½® ===
        html5: {
          // å¤„ç†HLS/DASHæµåª’ä½“
          vhs: {
            // æ˜¯å¦è¦†ç›–åŸç”Ÿæ’­æ”¾å™¨ (ç§»åŠ¨ç«¯å»ºè®®ä¿æŒåŸç”Ÿ)
            overrideNative: !device.isMobile,
            // å¯ç”¨ä½å»¶è¿Ÿæ¨¡å¼
            enableLowInitialPlaylist: device.isMobile,
            // ç§»åŠ¨ç«¯ç½‘ç»œä¼˜åŒ–
            experimentalBufferBasedABR: device.isMobile,
          },

          // åŸç”Ÿæ§åˆ¶ç›¸å…³
          nativeControlsForTouch: false, // ç¦ç”¨åŸç”Ÿè§¦æ‘¸æ§åˆ¶
          nativeAudioTracks: false, // ç¦ç”¨åŸç”ŸéŸ³è½¨
          nativeVideoTracks: false, // ç¦ç”¨åŸç”Ÿè§†é¢‘è½¨
          nativeTextTracks: false, // ç¦ç”¨åŸç”Ÿå­—å¹•
        },

        // === ç”¨æˆ·äº¤äº’é…ç½® ===
        userActions: {
          // ç‚¹å‡»æ’­æ”¾/æš‚åœ
          click: !device.isMobile, // ç§»åŠ¨ç«¯ç¦ç”¨ç‚¹å‡»ï¼ˆé¿å…å†²çªï¼‰
          // åŒå‡»å…¨å±
          doubleClick: !device.isMobile, // ç§»åŠ¨ç«¯ç¦ç”¨åŒå‡»
          // çƒ­é”®æ”¯æŒ
          hotkeys: !device.isMobile, // ç§»åŠ¨ç«¯ç¦ç”¨çƒ­é”®
        },

        // === æ’­æ”¾å™¨æ§åˆ¶æ é…ç½® ===
        controlBar: {
          // æ§åˆ¶æ ç»„ä»¶é…ç½®
          volumePanel: {
            inline: !device.isMobile, // ç§»åŠ¨ç«¯éŸ³é‡é¢æ¿ä¸å†…è”
          },
          // ğŸ”¥ MODIFIED: å…è®¸iOSæ˜¾ç¤ºå…¨å±æŒ‰é’®ï¼ˆåç»­åŠ¨æ€æ§åˆ¶ï¼‰
          fullscreenToggle: true,
        },

        // === å…¨å±é…ç½® ===
        fullscreen: {
          options: {
            // iOSå…¨å±é…ç½®
            navigationUI: device.isIOS ? "hide" : "auto",
          },
        },

        // === æ€§èƒ½ä¼˜åŒ–é…ç½® ===
        preload: device.isMobile ? "metadata" : "auto", // ç§»åŠ¨ç«¯ä»…é¢„åŠ è½½å…ƒæ•°æ®

        // === éŸ³é¢‘é…ç½® ===
        defaultVolume: device.isMobile ? 1.0 : 0.8, // ç§»åŠ¨ç«¯é»˜è®¤æ»¡éŸ³é‡
      };

      addEventToLog(
        "api",
        `Video.jsé…ç½®ç”Ÿæˆå®Œæˆ (ç§»åŠ¨ç«¯: ${device.isMobile})`,
        {
          mobileUi: playerConfig.mobileUi,
          techOrder: playerConfig.techOrder,
          preload: playerConfig.preload,
          userActions: playerConfig.userActions,
        }
      );

      const player = videojs("my-video", playerConfig);

      // === ğŸ”¥ NEW: å…¨å±æ¼”ç¤ºåŠŸèƒ½å˜é‡ ===
      let isFullscreenBlocked = device.isIOS; // iOSé»˜è®¤ç¦ç”¨
      let originalRequestFullscreen = null;
      let fullscreenEventListeners = [];

      // === é€šè¿‡ Video.js API ç¦ç”¨è¿›åº¦æ¡æ‹–æ‹½å’Œæ’­æ”¾é€Ÿç‡ ===
      player.ready(() => {
        addEventToLog("api", "æ’­æ”¾å™¨å°±ç»ªï¼Œå¼€å§‹é…ç½®æ§åˆ¶æƒé™");

        // === ç§»åŠ¨ç«¯ç‰¹æ®Šå¤„ç† ===
        if (device.isMobile) {
          addEventToLog(
            "api",
            `å¼€å§‹ç§»åŠ¨ç«¯ç‰¹æ®Šé…ç½® (${
              device.isIOS ? "iOS" : device.isAndroid ? "Android" : "Mobile"
            })`
          );

          // iOSç‰¹æ®Šå¤„ç†
          if (device.isIOS) {
            // ç¦ç”¨iOSçš„Picture-in-Picture
            const videoElement = player.el().querySelector("video");
            if (videoElement) {
              videoElement.setAttribute("disablePictureInPicture", "true");
              videoElement.setAttribute("playsinline", "true"); // å†…è”æ’­æ”¾
              // ğŸ”¥ NEW: å¼ºåˆ¶ç¦ç”¨iOSå…¨å±
              videoElement.setAttribute("webkit-playsinline", "true");
              videoElement.setAttribute("x5-playsinline", "true"); // è…¾è®¯X5å†…æ ¸
              addEventToLog("api", "âœ… iOS: å·²ç¦ç”¨PiPï¼Œå¯ç”¨å†…è”æ’­æ”¾ï¼Œç¦ç”¨å…¨å±");
            }

            // ğŸ”¥ MODIFIED: iOSé»˜è®¤éšè—å…¨å±æŒ‰é’®ï¼ˆä½†ä¿ç•™åŠ¨æ€æ§åˆ¶èƒ½åŠ›ï¼‰
            const fullscreenToggle = player.controlBar.fullscreenToggle;
            if (fullscreenToggle && isFullscreenBlocked) {
              fullscreenToggle.hide();
              fullscreenToggle.disable();
              // éšè—å…¨å±æŒ‰é’®çš„DOMå…ƒç´ 
              const fullscreenButton = fullscreenToggle.el();
              if (fullscreenButton) {
                fullscreenButton.style.display = "none";
                fullscreenButton.style.pointerEvents = "none";
              }
              addEventToLog(
                "api",
                "âœ… iOS: å…¨å±æŒ‰é’®é»˜è®¤éšè—ï¼ˆå¯é€šè¿‡æ¼”ç¤ºæŒ‰é’®åˆ‡æ¢ï¼‰"
              );
            }

            // ğŸ”¥ NEW: ä¿å­˜åŸå§‹å…¨å±æ–¹æ³•å¹¶é‡å†™
            originalRequestFullscreen = player.requestFullscreen;
            player.requestFullscreen = function () {
              if (isFullscreenBlocked) {
                addEventToLog("api", "âŒ iOS: å…¨å±è¯·æ±‚è¢«é˜»æ­¢");
                return Promise.reject(new Error("iOSå…¨å±å·²è¢«ç¦ç”¨"));
              }
              return originalRequestFullscreen.call(this);
            };

            // ğŸ”¥ NEW: ç¦ç”¨åŒå‡»å…¨å±
            const playerElement = player.el();
            if (playerElement) {
              playerElement.addEventListener(
                "dblclick",
                function (event) {
                  event.preventDefault();
                  event.stopPropagation();
                  event.stopImmediatePropagation();
                  addEventToLog("api", "âŒ iOS: åŒå‡»å…¨å±è¢«é˜»æ­¢");
                },
                true
              );
            }

            // å¤„ç†iOS Safariçš„å…¨å±è¡Œä¸º
            player.on("fullscreenchange", () => {
              if (player.isFullscreen()) {
                // iOSå…¨å±æ—¶çš„ç‰¹æ®Šå¤„ç†
                setTimeout(() => {
                  const fullscreenElement =
                    document.fullscreenElement ||
                    document.webkitFullscreenElement ||
                    document.mozFullScreenElement;
                  if (fullscreenElement) {
                    addEventToLog("api", "ğŸ iOSå…¨å±æ¨¡å¼æ¿€æ´»");
                  }
                }, 100);
              }
            });
          }

          // Androidç‰¹æ®Šå¤„ç†
          if (device.isAndroid) {
            // Android WebViewå…¼å®¹æ€§å¤„ç†
            const videoElement = player.el().querySelector("video");
            if (videoElement) {
              videoElement.setAttribute("webkit-playsinline", "true");
              videoElement.setAttribute("playsinline", "true");
              addEventToLog("api", "âœ… Android: å·²é…ç½®WebViewå…¼å®¹æ€§");
            }
          }

          // ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ–
          const playerElement = player.el();
          if (playerElement) {
            // ç¦ç”¨ç§»åŠ¨ç«¯çš„é»˜è®¤è§¦æ‘¸è¡Œä¸º
            playerElement.style.touchAction = "manipulation";
            playerElement.style.webkitTouchCallout = "none";
            playerElement.style.webkitUserSelect = "none";

            addEventToLog("api", "âœ… ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ–å·²åº”ç”¨");
          }

          // ç§»åŠ¨ç«¯ç½‘ç»œçŠ¶æ€ç›‘å¬
          if ("connection" in navigator) {
            const connection =
              navigator.connection ||
              navigator.mozConnection ||
              navigator.webkitConnection;
            if (connection) {
              addEventToLog(
                "api",
                `ç½‘ç»œçŠ¶æ€: ${connection.effectiveType || "unknown"}, ä¸‹è¡Œ: ${
                  connection.downlink || "unknown"
                }Mbps`
              );

              // æ ¹æ®ç½‘ç»œçŠ¶å†µè°ƒæ•´é¢„åŠ è½½ç­–ç•¥
              if (
                connection.effectiveType === "slow-2g" ||
                connection.effectiveType === "2g"
              ) {
                player.preload("none");
                addEventToLog("api", "âš ï¸ æ£€æµ‹åˆ°æ…¢ç½‘ç»œï¼Œç¦ç”¨é¢„åŠ è½½");
              }
            }
          }

          // ç§»åŠ¨ç«¯ç”µæ± çŠ¶æ€ç›‘å¬ï¼ˆå¦‚æœæ”¯æŒï¼‰
          if ("getBattery" in navigator) {
            navigator.getBattery().then((battery) => {
              addEventToLog(
                "api",
                `ç”µæ± çŠ¶æ€: ${Math.round(battery.level * 100)}%, å……ç”µä¸­: ${
                  battery.charging
                }`
              );

              // ä½ç”µé‡æ¨¡å¼ä¼˜åŒ–
              if (battery.level < 0.2 && !battery.charging) {
                addEventToLog("api", "ğŸ”‹ æ£€æµ‹åˆ°ä½ç”µé‡ï¼Œåº”ç”¨çœç”µæ¨¡å¼");
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ çœç”µä¼˜åŒ–
              }
            });
          }
        }

        // ç¦ç”¨æ’­æ”¾é€Ÿç‡æ§åˆ¶æŒ‰é’®
        const playbackRateMenuButton = player.controlBar.playbackRateMenuButton;
        if (playbackRateMenuButton) {
          playbackRateMenuButton.hide();
          playbackRateMenuButton.disable();
          addEventToLog("api", "âœ… æ’­æ”¾é€Ÿç‡æ§åˆ¶å·²é€šè¿‡ API ç¦ç”¨");
        }

        // è·å–è¿›åº¦æ¡æ§åˆ¶ç»„ä»¶
        const progressControl = player.controlBar.progressControl;

        if (progressControl) {
          // æ–¹æ³•1: å®Œå…¨ç¦ç”¨è¿›åº¦æ¡ç»„ä»¶
          progressControl.disable();
          addEventToLog("api", "âœ… è¿›åº¦æ¡ç»„ä»¶å·²é€šè¿‡ API ç¦ç”¨");

          // æ–¹æ³•2: é‡å†™ handleMouseDown æ–¹æ³•æ¥é˜»æ­¢æ‹–æ‹½
          if (progressControl.progressHolder) {
            const originalHandleMouseDown =
              progressControl.progressHolder.handleMouseDown;
            progressControl.progressHolder.handleMouseDown = function (event) {
              event.preventDefault();
              event.stopPropagation();
              addEventToLog("seek", "âŒ è¿›åº¦æ¡æ‹–æ‹½è¢« API é˜»æ­¢", {
                attemptedTime: "N/A",
                currentTime: formatTime(player.currentTime()),
              });
              return false;
            };

            // åŒæ ·å¤„ç†è§¦æ‘¸äº‹ä»¶
            const originalHandleTouchStart =
              progressControl.progressHolder.handleTouchStart;
            if (originalHandleTouchStart) {
              progressControl.progressHolder.handleTouchStart = function (
                event
              ) {
                event.preventDefault();
                event.stopPropagation();
                addEventToLog("seek", "âŒ è¿›åº¦æ¡è§¦æ‘¸è¢« API é˜»æ­¢");
                return false;
              };
            }
          }

          // æ–¹æ³•3: ç¦ç”¨ç‚¹å‡»è·³è½¬
          if (progressControl.el()) {
            progressControl.el().style.pointerEvents = "none";
            progressControl.el().style.cursor = "not-allowed";
          }

          addEventToLog("api", "ğŸ”’ æ‰€æœ‰è¿›åº¦æ¡äº¤äº’å·²ç¦ç”¨ (API + äº‹ä»¶å¤„ç†)");
        }

        // é”å®šæ’­æ”¾é€Ÿç‡ä¸º1xï¼Œé˜²æ­¢ç¨‹åºä¿®æ”¹
        const originalPlaybackRate = player.playbackRate;
        player.playbackRate = function (rate) {
          if (arguments.length === 0) {
            return 1; // å§‹ç»ˆè¿”å›1xæ’­æ”¾é€Ÿç‡
          }
          // é˜»æ­¢è®¾ç½®æ’­æ”¾é€Ÿç‡
          if (rate !== 1) {
            addEventToLog("api", `âŒ æ’­æ”¾é€Ÿç‡ä¿®æ”¹è¢«é˜»æ­¢: å°è¯•è®¾ç½®ä¸º ${rate}x`, {
              requested: rate,
              current: 1,
              message: "APIå·²é”å®šæ’­æ”¾é€Ÿç‡ä¸º1x",
            });
            return this;
          }
          return originalPlaybackRate.call(this, rate);
        };

        addEventToLog("api", "ğŸ”’ æ’­æ”¾é€Ÿç‡å·²é”å®šä¸º 1x");

        // ç›‘å¬å…¨å±å˜åŒ–
        player.on("fullscreenchange", () => {
          const isFullscreen = player.isFullscreen();
          addEventToLog(
            "fullscreenchange",
            `å…¨å±çŠ¶æ€å˜åŒ–: ${isFullscreen ? "è¿›å…¥" : "é€€å‡º"}å…¨å±`,
            {
              isFullscreen: isFullscreen,
            }
          );

          // ç¡®ä¿å…¨å±æ¨¡å¼ä¸‹è¿›åº¦æ¡ä»ç„¶è¢«ç¦ç”¨
          if (isFullscreen && progressControl) {
            setTimeout(() => {
              progressControl.disable();
              if (progressControl.el()) {
                progressControl.el().style.pointerEvents = "none";
              }
              addEventToLog("api", "ğŸ”’ å…¨å±æ¨¡å¼ä¸‹é‡æ–°ç¦ç”¨è¿›åº¦æ¡");
            }, 100);
          }
        });
      });

      // === äº‹ä»¶ç›‘å¬å’Œä¸ŠæŠ¥ ===
      let hasStarted = false;
      let lastReportedTime = -1;

      function reportToServer(eventName, data) {
        // æ§åˆ¶å°è¾“å‡º
        console.log(`[Event Reported] Event: ${eventName}`, data);

        // æ¨¡æ‹ŸAPIè°ƒç”¨
        // fetch('/api/report', {
        //     method: 'POST',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify({ event: eventName, data: data })
        // });
      }

      // æ’­æ”¾å¼€å§‹äº‹ä»¶
      player.on("playing", () => {
        if (!hasStarted) {
          hasStarted = true;
          const data = {
            currentTime: player.currentTime(),
            duration: player.duration(),
            message: "Playback has started.",
          };
          reportToServer("start", data);
          addEventToLog("start", "è§†é¢‘å¼€å§‹æ’­æ”¾", {
            currentTime: formatTime(data.currentTime),
            duration: formatTime(data.duration),
          });
        }
      });

      // æ’­æ”¾æš‚åœäº‹ä»¶
      player.on("pause", () => {
        const data = {
          currentTime: player.currentTime(),
          duration: player.duration(),
        };
        addEventToLog("pause", "è§†é¢‘æš‚åœ", {
          currentTime: formatTime(data.currentTime),
          duration: formatTime(data.duration),
        });
      });

      // ç»§ç»­æ’­æ”¾äº‹ä»¶
      player.on("play", () => {
        if (hasStarted) {
          // é¿å…ä¸ playing äº‹ä»¶é‡å¤
          const data = {
            currentTime: player.currentTime(),
            duration: player.duration(),
          };
          addEventToLog("play", "è§†é¢‘ç»§ç»­æ’­æ”¾", {
            currentTime: formatTime(data.currentTime),
            duration: formatTime(data.duration),
          });
        }
      });

      // æ—¶é—´æ›´æ–°äº‹ä»¶ (èŠ‚æµå¤„ç†)
      player.on("timeupdate", () => {
        const currentTime = Math.floor(player.currentTime());
        const duration = player.duration();

        // æ¯éš”5ç§’ä¸ŠæŠ¥ä¸€æ¬¡è¿›åº¦
        if (
          currentTime > 0 &&
          currentTime % 5 === 0 &&
          currentTime !== lastReportedTime
        ) {
          lastReportedTime = currentTime;
          const data = {
            currentTime: currentTime,
            duration: duration,
            progress: Math.round((currentTime / duration) * 100),
          };
          reportToServer("timeupdate", data);
          addEventToLog("timeupdate", `æ’­æ”¾è¿›åº¦æ›´æ–° (${data.progress}%)`, {
            currentTime: formatTime(currentTime),
            duration: formatTime(duration),
            progress: `${data.progress}%`,
          });
        }
      });

      // æ’­æ”¾ç»“æŸäº‹ä»¶
      player.on("ended", () => {
        const data = {
          message: "Playback has finished.",
          duration: player.duration(),
        };
        reportToServer("ended", data);
        addEventToLog("ended", "è§†é¢‘æ’­æ”¾å®Œæˆ", {
          duration: formatTime(data.duration),
        });
      });

      // éŸ³é‡å˜åŒ–äº‹ä»¶
      player.on("volumechange", () => {
        const volume = Math.round(player.volume() * 100);
        const muted = player.muted();
        addEventToLog(
          "volumechange",
          `éŸ³é‡å˜åŒ–: ${muted ? "é™éŸ³" : volume + "%"}`,
          {
            volume: volume,
            muted: muted,
          }
        );
      });

      // æ’­æ”¾é€Ÿç‡å˜åŒ–äº‹ä»¶
      player.on("ratechange", () => {
        const rate = player.playbackRate();
        addEventToLog("ratechange", `æ’­æ”¾é€Ÿç‡å˜åŒ–: ${rate}x`, {
          playbackRate: rate,
        });
      });

      // åŠ è½½å¼€å§‹äº‹ä»¶
      player.on("loadstart", () => {
        addEventToLog("loadstart", "å¼€å§‹åŠ è½½è§†é¢‘èµ„æº");
      });

      // å¯ä»¥æ’­æ”¾äº‹ä»¶
      player.on("canplay", () => {
        addEventToLog("canplay", "è§†é¢‘èµ„æºåŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æ’­æ”¾", {
          duration: formatTime(player.duration() || 0),
        });
      });

      // é”™è¯¯äº‹ä»¶
      player.on("error", () => {
        const error = player.error();
        addEventToLog("error", "æ’­æ”¾å™¨å‘ç”Ÿé”™è¯¯", {
          code: error?.code,
          message: error?.message,
        });
      });

      // å°è¯•æ‹–æ‹½æ£€æµ‹ (ä½œä¸ºå¤‡ç”¨æ£€æµ‹)
      player.on("seeking", () => {
        addEventToLog("seek", "âš ï¸  æ£€æµ‹åˆ° seeking äº‹ä»¶ (å¯èƒ½æ˜¯ç¨‹åºè§¦å‘)", {
          currentTime: formatTime(player.currentTime()),
          message: "è¿™ä¸åº”è¯¥é€šè¿‡æ‹–æ‹½è§¦å‘",
        });
      });

      // åˆå§‹åŒ–å®Œæˆ
      addEventToLog("api", "âœ… æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®å®Œæˆ");

      // === ğŸ”¥ NEW: å…¨å±æ¼”ç¤ºåˆ‡æ¢åŠŸèƒ½ ===
      function updateFullscreenStatus() {
        const statusIndicator = document.getElementById("fullscreen-status");
        const statusText = document.getElementById("fullscreen-text");
        const toggleButton = document.getElementById("toggleFullscreenDemo");

        if (isFullscreenBlocked) {
          statusIndicator.className = "status-indicator status-disabled";
          statusText.textContent = device.isIOS
            ? "iOSç¦ç”¨ (é€šè¿‡API)"
            : "å·²ç¦ç”¨ (æ¼”ç¤º)";
          toggleButton.textContent = "å¯ç”¨å…¨å± (æµ‹è¯•)";
          toggleButton.style.background = "#48bb78";
        } else {
          statusIndicator.className = "status-indicator status-active";
          statusText.textContent = device.isIOS
            ? "iOSå¯ç”¨ (æµ‹è¯•æ¨¡å¼)"
            : "å·²å¯ç”¨";
          toggleButton.textContent = "ç¦ç”¨å…¨å± (æµ‹è¯•)";
          toggleButton.style.background = "#f56565";
        }
      }

      function toggleFullscreenDemo() {
        isFullscreenBlocked = !isFullscreenBlocked;

        const fullscreenToggle = player.controlBar.fullscreenToggle;

        if (isFullscreenBlocked) {
          // ç¦ç”¨å…¨å±
          if (fullscreenToggle) {
            fullscreenToggle.hide();
            fullscreenToggle.disable();
            const fullscreenButton = fullscreenToggle.el();
            if (fullscreenButton) {
              fullscreenButton.style.display = "none";
              fullscreenButton.style.pointerEvents = "none";
            }
          }
          addEventToLog("api", "ğŸ”’ æ¼”ç¤º: å…¨å±åŠŸèƒ½å·²ç¦ç”¨");
        } else {
          // å¯ç”¨å…¨å±
          if (fullscreenToggle) {
            fullscreenToggle.show();
            fullscreenToggle.enable();
            const fullscreenButton = fullscreenToggle.el();
            if (fullscreenButton) {
              fullscreenButton.style.display = "";
              fullscreenButton.style.pointerEvents = "";
            }
          }
          addEventToLog(
            "api",
            device.isIOS
              ? "ğŸ”“ æ¼”ç¤º: iOSå…¨å±æŒ‰é’®å·²æ˜¾ç¤º (ç‚¹å‡»ä¼šæ¿€æ´»åŸç”Ÿæ’­æ”¾å™¨)"
              : "ğŸ”“ æ¼”ç¤º: å…¨å±åŠŸèƒ½å·²å¯ç”¨"
          );
        }

        updateFullscreenStatus();
      }

      // ç»‘å®šæŒ‰é’®äº‹ä»¶
      document
        .getElementById("toggleFullscreenDemo")
        .addEventListener("click", toggleFullscreenDemo);

      // åˆå§‹åŒ–çŠ¶æ€æ˜¾ç¤º
      updateFullscreenStatus();
    </script>
  </body>
</html>
